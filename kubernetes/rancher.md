---
description: å®˜ç½‘https://rancher.com/
---

# ğŸ‡ Rancher

#### [å®˜æ–¹æ–‡æ¡£](https://rancher.com/docs/rancher/latest/en/)&#x20;

## 1ã€ç®€ä»‹

Rancheræ˜¯ä¸€ä¸ªå¼€æºè½¯ä»¶å¹³å°ï¼Œä½¿ç»„ç»‡èƒ½å¤Ÿåœ¨ç”Ÿäº§ä¸­è¿è¡Œå’Œç®¡ç†Dockerå’ŒKubernetesã€‚ä½¿ç”¨Rancherï¼Œç»„ç»‡ä¸å†éœ€è¦ä½¿ç”¨ä¸€å¥—ç‹¬ç‰¹çš„å¼€æºæŠ€æœ¯ä»å¤´å¼€å§‹æ„å»ºå®¹å™¨æœåŠ¡å¹³å°ã€‚Rancheræä¾›äº†ç®¡ç†ç”Ÿäº§ä¸­çš„å®¹å™¨æ‰€éœ€çš„æ•´ä¸ªè½¯ä»¶å †æ ˆã€‚

## 2ã€ä¸»è¦ç»„ä»¶

### 2.1ã€INFRASTRUCTURE ORCHESTRATION  åŸºç¡€æ¶æ„æµç¨‹

Rancherä»¥Linuxä¸»æœºçš„å½¢å¼ä»ä»»ä½•å…¬å…±æˆ–ç§æœ‰äº‘ä¸­è·å–åŸå§‹è®¡ç®—èµ„æºã€‚æ¯ä¸ªLinuxä¸»æœºå¯ä»¥æ˜¯è™šæ‹Ÿæœºæˆ–ç‰©ç†æœºã€‚Rancherå¯¹æ¯ä¸ªä¸»æœºçš„æœŸæœ›ä¸è¶…è¿‡CPUï¼Œå†…å­˜ï¼Œæœ¬åœ°ç£ç›˜å­˜å‚¨å’Œç½‘ç»œè¿æ¥ã€‚ä»Rancherçš„è§’åº¦æ¥çœ‹ï¼Œæ¥è‡ªäº‘æä¾›å•†çš„VMå®ä¾‹å’Œæ‰˜ç®¡åœ¨äº‘è®¾æ–½ä¸­çš„è£¸æœºæœåŠ¡å™¨æ˜¯æ— æ³•åŒºåˆ†çš„ã€‚

Rancherå®ç°äº†å¯ç§»æ¤çš„åŸºç¡€ç»“æ„æœåŠ¡å±‚ï¼Œä¸“é—¨ä¸ºå®¹å™¨åŒ–åº”ç”¨ç¨‹åºæä¾›åŠ¨åŠ›ã€‚RancheråŸºç¡€æ¶æ„æœåŠ¡åŒ…æ‹¬ç½‘ç»œï¼Œå­˜å‚¨ï¼Œè´Ÿè½½å¹³è¡¡å™¨ï¼ŒDNSå’Œå®‰å…¨æ€§ã€‚RancheråŸºç¡€ç»“æ„æœåŠ¡é€šå¸¸æœ¬èº«æ˜¯ä½œä¸ºå®¹å™¨éƒ¨ç½²çš„ï¼Œå› æ­¤åŒä¸€RancheråŸºç¡€ç»“æ„æœåŠ¡å¯ä»¥åœ¨æ¥è‡ªä»»ä½•äº‘çš„ä»»ä½•Linuxä¸»æœºä¸Šè¿è¡Œã€‚

### 2.2ã€å®¹å™¨ç¼–æ’å’Œè°ƒåº¦  CONTAINER ORCHESTRATION AND SCHEDULING

è®¸å¤šç”¨æˆ·é€‰æ‹©ä½¿ç”¨å®¹å™¨ç¼–æ’å’Œè°ƒåº¦æ¡†æ¶æ¥è¿è¡Œå®¹å™¨åŒ–çš„åº”ç”¨ç¨‹åºã€‚Rancheråˆ†å‘äº†å½“ä»Šæ‰€æœ‰æµè¡Œçš„å®¹å™¨ç¼–æ’å’Œè°ƒåº¦æ¡†æ¶ï¼ŒåŒ…æ‹¬Docker Swarmï¼ŒKuberneteså’ŒMesosã€‚åŒä¸€ç”¨æˆ·å¯ä»¥åˆ›å»ºå¤šä¸ªSwarmæˆ–Kubernetesé›†ç¾¤ã€‚ç„¶åï¼Œä»–ä»¬å¯ä»¥ä½¿ç”¨æœ¬æœºSwarmæˆ–Kuberneteså·¥å…·æ¥ç®¡ç†å…¶åº”ç”¨ç¨‹åºã€‚

é™¤äº†Swarmï¼ŒKuberneteså’ŒMesoså¤–ï¼ŒRancherè¿˜æ”¯æŒå…¶è‡ªå·±çš„ç§°ä¸ºCattleçš„å®¹å™¨ç¼–æ’å’Œè°ƒåº¦æ¡†æ¶ã€‚Rancherå¹¿æ³›ä½¿ç”¨Cattleæ¥åè°ƒåŸºç¡€æ¶æ„æœåŠ¡ä»¥åŠè®¾ç½®ï¼Œç®¡ç†å’Œå‡çº§Swarmï¼ŒKuberneteså’ŒMesosé›†ç¾¤ã€‚

### 2.3ã€åº”ç”¨ç›®å½• APPLICATION CATALOG

Rancherç”¨æˆ·åªéœ€å•å‡»ä¸€ä¸‹æŒ‰é’®ï¼Œå³å¯ä»åº”ç”¨ç¨‹åºç›®å½•ä¸­éƒ¨ç½²æ•´ä¸ªå¤šå®¹å™¨é›†ç¾¤åº”ç”¨ç¨‹åºã€‚å½“æ–°ç‰ˆæœ¬çš„åº”ç”¨ç¨‹åºå¯ç”¨æ—¶ï¼Œç”¨æˆ·å¯ä»¥ç®¡ç†å·²éƒ¨ç½²çš„åº”ç”¨ç¨‹åºå¹¶æ‰§è¡Œå…¨è‡ªåŠ¨å‡çº§ã€‚Rancherç»´æŠ¤ç”±Rancherç¤¾åŒºè´¡çŒ®çš„æµè¡Œåº”ç”¨ç¨‹åºç»„æˆçš„å…¬å…±ç›®å½•ã€‚Rancherç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„ç§æœ‰ç›®å½•ã€‚

### 2.4ã€ä¼ä¸šçº§æ§åˆ¶ ENTERPRISE-GRADE CONTROL

Rancheræ”¯æŒçµæ´»çš„ç”¨æˆ·èº«ä»½éªŒè¯æ’ä»¶ï¼Œå¹¶ä¸Active Directoryï¼ŒLDAPå’ŒGitHubè¿›è¡Œäº†é¢„å…ˆæ„å»ºçš„ç”¨æˆ·èº«ä»½éªŒè¯é›†æˆã€‚Rancheråœ¨ç¯å¢ƒçº§åˆ«æ”¯æŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ï¼Œå…è®¸ç”¨æˆ·å’Œç»„å…±äº«æˆ–æ‹’ç»å¯¹å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒçš„è®¿é—®ã€‚

### 2.5ã€Rancherçš„ä¸»è¦ç»„ä»¶å’ŒåŠŸèƒ½ã€‚

![](https://rancher.com/docs/one-point-x/img/rancher/rancher\_overview\_2.png)

### 2.6ã€ä¸ºä»€ä¹ˆä½¿ç”¨rancherï¼Ÿ

**Rancheræ˜¯ä¾›é‡‡ç”¨å®¹å™¨çš„å›¢é˜Ÿä½¿ç”¨çš„å®Œæ•´è½¯ä»¶å †æ ˆã€‚å®ƒè§£å†³äº†åœ¨ä»»ä½•åŸºç¡€æ¶æ„ä¸Šç®¡ç†å¤šä¸ªKubernetesé›†ç¾¤çš„è¿è¥å’Œå®‰å…¨æŒ‘æˆ˜ï¼ŒåŒæ—¶ä¸ºDevOpså›¢é˜Ÿæä¾›äº†ç”¨äºè¿è¡Œå®¹å™¨åŒ–å·¥ä½œè´Ÿè½½çš„é›†æˆå·¥å…·**ã€‚\
ç”¨æˆ·ä¸éœ€è¦æ·±å…¥äº†è§£kubernetesæ¦‚å¿µå°±å¯ä»¥ä½¿ç”¨rancherï¼ŒrancheråŒ…å«åº”ç”¨å•†åº—ï¼Œæ”¯æŒä¸€é”®éƒ¨ç½²helmå’Œcomposeæ¨¡æ¿ã€‚rancheré€šè¿‡å„ç§äº‘ã€æœ¬åœ°ç”Ÿæ€ç³»ç»Ÿäº§å“è®¤è¯ï¼Œå…¶ä¸­åŒ…æ‹¬å®‰å…¨å·¥å…·ï¼Œç›‘æ§ç³»ç»Ÿï¼Œå®¹å™¨ä»“åº“ä»¥åŠå­˜å‚¨å’Œç½‘ç»œé©±åŠ¨ç¨‹åºï¼Œä¸‹å›¾è¯´æ˜rancheråœ¨ITå’ŒDevOpsç»„ç»‡ä¸­æ‰®æ¼”çš„è§’è‰²ï¼Œæ¯ä¸ªå›¢é˜Ÿéƒ½ä¼šåœ¨ä»–ä»¬é€‰æ‹©çš„å…¬å…±äº‘æˆ–ç§æœ‰äº‘ä¸Šéƒ¨ç½²åº”ç”¨

### 2.7ã€ä¸»è¦åŠŸèƒ½

* å†…ç½®CI/CDï¼›&#x20;
* å‘Šè­¦å’Œæ—¥å¿—æ”¶é›†ï¼›&#x20;
* å¤šé›†ç¾¤ç®¡ç†ï¼›&#x20;
* rancher kubernetes engineï¼ˆRKEï¼‰;&#x20;
* ä¸äº‘KubernetesæœåŠ¡ï¼ˆå¦‚GKE,EKSå’ŒAKSï¼‰é›†æˆï¼›

## 3ã€å®‰è£…éƒ¨ç½²

### 3.1ã€å•æœºå®¹å™¨å¯åŠ¨

```
docker run -d --restart=always --name rancher -p 80:80 -p 443:443 rancher/rancher:stable
```

### 3.2ã€helm3éƒ¨ç½²rancher

```
helm repo add rancher-stable https://releases.rancher.com/server-charts/stable

[root@k8s-node001 kubernetes]# helm search repo
NAME                  	CHART VERSION	APP VERSION	DESCRIPTION
rancher-stable/rancher	2.4.5        	v2.4.5     	Install Rancher Server to manage Kubernetes clu... 
```

#### è‡ªç­¾è¯ä¹¦å®‰è£…è¿‡ç¨‹

#### ç”Ÿæˆè‡ªå®šä¹‰è¯ä¹¦ï¼Œæœ¬æ¡ˆä¾‹ä½¿ç”¨è‡ªå®šä¹‰åŸŸåä¸ºrancher.sfkj.sit

{% tabs %}
{% tab title="shell" %}
```
chmod +x create_self-signed-cert.sh
./create_self-signed-cert.sh --ssl-domain=rancher.sfkj.sit


[root@k8s-node001 tls]# ll
æ€»ç”¨é‡ 44
-rw-r--r-- 1 root root 1131 7æœˆ  21 11:50 cacerts.pem
-rw-r--r-- 1 root root   17 7æœˆ  21 11:50 cacerts.srl
-rw-r--r-- 1 root root 1675 7æœˆ  21 11:50 cakey.pem
-rwxr-xr-x 1 root root 5220 7æœˆ  21 11:49 create_self-signed-cert.sh
-rw-r--r-- 1 root root  241 7æœˆ  21 11:50 openssl.cnf
-rw-r--r-- 1 root root 2238 7æœˆ  21 11:50 rancher.sfkj.sit.crt
-rw-r--r-- 1 root root 1017 7æœˆ  21 11:50 rancher.sfkj.sit.csr
-rw-r--r-- 1 root root 1679 7æœˆ  21 11:50 rancher.sfkj.sit.key
-rw-r--r-- 1 root root 2238 7æœˆ  21 11:50 tls.crt
-rw-r--r-- 1 root root 1679 7æœˆ  21 11:50 tls.key
```
{% endtab %}

{% tab title="create_self-signed-cert.sh" %}
```
#!/bin/bash -e

help ()
{
    echo  ' ================================================================ '
    echo  ' --ssl-domain: ç”Ÿæˆsslè¯ä¹¦éœ€è¦çš„ä¸»åŸŸåï¼Œå¦‚ä¸æŒ‡å®šåˆ™é»˜è®¤ä¸ºwww.rancher.localï¼Œå¦‚æœæ˜¯ipè®¿é—®æœåŠ¡ï¼Œåˆ™å¯å¿½ç•¥ï¼›'
    echo  ' --ssl-trusted-ip: ä¸€èˆ¬sslè¯ä¹¦åªä¿¡ä»»åŸŸåçš„è®¿é—®è¯·æ±‚ï¼Œæœ‰æ—¶å€™éœ€è¦ä½¿ç”¨ipå»è®¿é—®serverï¼Œé‚£ä¹ˆéœ€è¦ç»™sslè¯ä¹¦æ·»åŠ æ‰©å±•IPï¼Œå¤šä¸ªIPç”¨é€—å·éš”å¼€ï¼›'
    echo  ' --ssl-trusted-domain: å¦‚æœæƒ³å¤šä¸ªåŸŸåè®¿é—®ï¼Œåˆ™æ·»åŠ æ‰©å±•åŸŸåï¼ˆSSL_TRUSTED_DOMAINï¼‰,å¤šä¸ªæ‰©å±•åŸŸåç”¨é€—å·éš”å¼€ï¼›'
    echo  ' --ssl-size: sslåŠ å¯†ä½æ•°ï¼Œé»˜è®¤2048ï¼›'
    echo  ' --ssl-cn: å›½å®¶ä»£ç (2ä¸ªå­—æ¯çš„ä»£å·),é»˜è®¤CN;'
    echo  ' ä½¿ç”¨ç¤ºä¾‹:'
    echo  ' ./create_self-signed-cert.sh --ssl-domain=www.test.com --ssl-trusted-domain=www.test2.com \ '
    echo  ' --ssl-trusted-ip=1.1.1.1,2.2.2.2,3.3.3.3 --ssl-size=2048 --ssl-date=3650'
    echo  ' ================================================================'
}

case "$1" in
    -h|--help) help; exit;;
esac

if [[ $1 == '' ]];then
    help;
    exit;
fi

CMDOPTS="$*"
for OPTS in $CMDOPTS;
do
    key=$(echo ${OPTS} | awk -F"=" '{print $1}' )
    value=$(echo ${OPTS} | awk -F"=" '{print $2}' )
    case "$key" in
        --ssl-domain) SSL_DOMAIN=$value ;;
        --ssl-trusted-ip) SSL_TRUSTED_IP=$value ;;
        --ssl-trusted-domain) SSL_TRUSTED_DOMAIN=$value ;;
        --ssl-size) SSL_SIZE=$value ;;
        --ssl-date) SSL_DATE=$value ;;
        --ca-date) CA_DATE=$value ;;
        --ssl-cn) CN=$value ;;
    esac
done

# CAç›¸å…³é…ç½®
CA_DATE=${CA_DATE:-3650}
CA_KEY=${CA_KEY:-cakey.pem}
CA_CERT=${CA_CERT:-cacerts.pem}
CA_DOMAIN=cattle-ca

# sslç›¸å…³é…ç½®
SSL_CONFIG=${SSL_CONFIG:-$PWD/openssl.cnf}
SSL_DOMAIN=${SSL_DOMAIN:-'www.rancher.local'}
SSL_DATE=${SSL_DATE:-3650}
SSL_SIZE=${SSL_SIZE:-2048}

## å›½å®¶ä»£ç (2ä¸ªå­—æ¯çš„ä»£å·),é»˜è®¤CN;
CN=${CN:-CN}

SSL_KEY=$SSL_DOMAIN.key
SSL_CSR=$SSL_DOMAIN.csr
SSL_CERT=$SSL_DOMAIN.crt

echo -e "\033[32m ---------------------------- \033[0m"
echo -e "\033[32m       | ç”Ÿæˆ SSL Cert |       \033[0m"
echo -e "\033[32m ---------------------------- \033[0m"

if [[ -e ./${CA_KEY} ]]; then
    echo -e "\033[32m ====> 1. å‘ç°å·²å­˜åœ¨CAç§é’¥ï¼Œå¤‡ä»½"${CA_KEY}"ä¸º"${CA_KEY}"-bakï¼Œç„¶åé‡æ–°åˆ›å»º \033[0m"
    mv ${CA_KEY} "${CA_KEY}"-bak
    openssl genrsa -out ${CA_KEY} ${SSL_SIZE}
else
    echo -e "\033[32m ====> 1. ç”Ÿæˆæ–°çš„CAç§é’¥ ${CA_KEY} \033[0m"
    openssl genrsa -out ${CA_KEY} ${SSL_SIZE}
fi

if [[ -e ./${CA_CERT} ]]; then
    echo -e "\033[32m ====> 2. å‘ç°å·²å­˜åœ¨CAè¯ä¹¦ï¼Œå…ˆå¤‡ä»½"${CA_CERT}"ä¸º"${CA_CERT}"-bakï¼Œç„¶åé‡æ–°åˆ›å»º \033[0m"
    mv ${CA_CERT} "${CA_CERT}"-bak
    openssl req -x509 -sha256 -new -nodes -key ${CA_KEY} -days ${CA_DATE} -out ${CA_CERT} -subj "/C=${CN}/CN=${CA_DOMAIN}"
else
    echo -e "\033[32m ====> 2. ç”Ÿæˆæ–°çš„CAè¯ä¹¦ ${CA_CERT} \033[0m"
    openssl req -x509 -sha256 -new -nodes -key ${CA_KEY} -days ${CA_DATE} -out ${CA_CERT} -subj "/C=${CN}/CN=${CA_DOMAIN}"
fi

echo -e "\033[32m ====> 3. ç”ŸæˆOpensslé…ç½®æ–‡ä»¶ ${SSL_CONFIG} \033[0m"
cat > ${SSL_CONFIG} <<EOM
[req]
req_extensions = v3_req
distinguished_name = req_distinguished_name
[req_distinguished_name]
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = clientAuth, serverAuth
EOM

if [[ -n ${SSL_TRUSTED_IP} || -n ${SSL_TRUSTED_DOMAIN} ]]; then
    cat >> ${SSL_CONFIG} <<EOM
subjectAltName = @alt_names
[alt_names]
EOM
    IFS=","
    dns=(${SSL_TRUSTED_DOMAIN})
    dns+=(${SSL_DOMAIN})
    for i in "${!dns[@]}"; do
      echo DNS.$((i+1)) = ${dns[$i]} >> ${SSL_CONFIG}
    done

    if [[ -n ${SSL_TRUSTED_IP} ]]; then
        ip=(${SSL_TRUSTED_IP})
        for i in "${!ip[@]}"; do
          echo IP.$((i+1)) = ${ip[$i]} >> ${SSL_CONFIG}
        done
    fi
fi

echo -e "\033[32m ====> 4. ç”ŸæˆæœåŠ¡SSL KEY ${SSL_KEY} \033[0m"
openssl genrsa -out ${SSL_KEY} ${SSL_SIZE}

echo -e "\033[32m ====> 5. ç”ŸæˆæœåŠ¡SSL CSR ${SSL_CSR} \033[0m"
openssl req -sha256 -new -key ${SSL_KEY} -out ${SSL_CSR} -subj "/C=${CN}/CN=${SSL_DOMAIN}" -config ${SSL_CONFIG}

echo -e "\033[32m ====> 6. ç”ŸæˆæœåŠ¡SSL CERT ${SSL_CERT} \033[0m"
openssl x509 -sha256 -req -in ${SSL_CSR} -CA ${CA_CERT} \
    -CAkey ${CA_KEY} -CAcreateserial -out ${SSL_CERT} \
    -days ${SSL_DATE} -extensions v3_req \
    -extfile ${SSL_CONFIG}

echo -e "\033[32m ====> 7. è¯ä¹¦åˆ¶ä½œå®Œæˆ \033[0m"
echo
echo -e "\033[32m ====> 8. ä»¥YAMLæ ¼å¼è¾“å‡ºç»“æœ \033[0m"
echo "----------------------------------------------------------"
echo "ca_key: |"
cat $CA_KEY | sed 's/^/  /'
echo
echo "ca_cert: |"
cat $CA_CERT | sed 's/^/  /'
echo
echo "ssl_key: |"
cat $SSL_KEY | sed 's/^/  /'
echo
echo "ssl_csr: |"
cat $SSL_CSR | sed 's/^/  /'
echo
echo "ssl_cert: |"
cat $SSL_CERT | sed 's/^/  /'
echo

echo -e "\033[32m ====> 9. é™„åŠ CAè¯ä¹¦åˆ°Certæ–‡ä»¶ \033[0m"
cat ${CA_CERT} >> ${SSL_CERT}
echo "ssl_cert: |"
cat $SSL_CERT | sed 's/^/  /'
echo

echo -e "\033[32m ====> 10. é‡å‘½åæœåŠ¡è¯ä¹¦ \033[0m"
echo "cp ${SSL_DOMAIN}.key tls.key"
cp ${SSL_DOMAIN}.key tls.key
echo "cp ${SSL_DOMAIN}.crt tls.crt"
cp ${SSL_DOMAIN}.crt tls.crt
```
{% endtab %}
{% endtabs %}

### 3.3ã€ä½¿ç”¨helmå®‰è£…rancher

```
# åˆ›å»ºnamespace
kubectl create namespace cattle-system
# æœåŠ¡è¯ä¹¦å’Œç§é’¥å¯†æ–‡
kubectl -n cattle-system create secret tls tls-rancher-ingress --cert=./tls.crt --key=./tls.key
# ca è¯ä¹¦å¯†æ–‡
kubectl -n cattle-system create secret generic tls-ca --from-file=./cacerts.pem
# å®‰è£…rancher server
helm install rancher  rancher-stable/rancher --namespace cattle-system --set hostname=rancher.sfkj.sit --set ingress.tls.source=secret --set privateCA=true
```

#### æŸ¥çœ‹ç»“æœ

```
[root@k8s-node001 tls]# kubectl get all -n cattle-system
NAME                           READY   STATUS    RESTARTS   AGE
pod/rancher-64b9795c65-6mk6c   1/1     Running   0          28m
pod/rancher-64b9795c65-rn88w   1/1     Running   0          28m
pod/rancher-64b9795c65-tjzvx   1/1     Running   1          28m

NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/rancher   ClusterIP   10.102.202.133   <none>        80/TCP    28m

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/rancher   3/3     3            3           28m

NAME                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/rancher-64b9795c65   3         3         3       28m
```

{% hint style="info" %}
é»˜è®¤ingressæ’ä»¶ä¸ºnginx-ingress, å¦‚æœä½¿ç”¨çš„æ˜¯traefikéœ€å…ˆæ›´æ”¹ingressï¼Œyamlå¦‚ä¸‹ï¼š
{% endhint %}

```
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    meta.helm.sh/release-name: rancher
    meta.helm.sh/release-namespace: cattle-system
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
  name: rancher
  namespace: cattle-system

spec:
  rules:
  - host: rancher.sfkj.sit
    http:
      paths:
      - backend:
          serviceName: rancher
          servicePort: 80
  tls:
  - secretName: tls-rancher-ingress
status:
  loadBalancer: {}
```

#### nginxå¢åŠ å¦‚ä¸‹é…ç½®

```
upstream https_backend_traefik {
    #server k8s-node001:8181    max_fails=3 fail_timeout=10s;
    server k8s-node002:8443    max_fails=3 fail_timeout=10s;
    #server 10.105.28.224:8080   max_fails=3 fail_timeout=10s;
}

server {
    listen 443 ssl;
    server_name rancher.sfkj.sit;
    #ssl on;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;

    ssl_certificate /data/kubernetes/tls/tls.crt;
    ssl_certificate_key  /data/kubernetes/tls/tls.key;

    location / {
        proxy_pass https://https_backend_traefik;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection upgrade;
        proxy_set_header Host       $http_host;
        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;
    }
}
```

#### ä¸ºAgent Podæ·»åŠ ä¸»æœºåˆ«å(/etc/hosts)

å¦‚æœæ‚¨æ²¡æœ‰å†…éƒ¨DNSæœåŠ¡å™¨è€Œæ˜¯é€šè¿‡æ·»åŠ `/etc/hosts`ä¸»æœºåˆ«åçš„æ–¹å¼æŒ‡å®šçš„Rancher ServeråŸŸåï¼Œé‚£ä¹ˆä¸ç®¡é€šè¿‡å“ªç§æ–¹å¼(è‡ªå®šä¹‰ã€å¯¼å…¥ã€Hosté©±åŠ¨ç­‰)åˆ›å»ºK8Sé›†ç¾¤ï¼ŒK8Sé›†ç¾¤è¿è¡Œèµ·æ¥ä¹‹åï¼Œå› ä¸º`cattle-cluster-agent Pod`å’Œ`cattle-node-agent pod`æ— æ³•é€šè¿‡DNSè®°å½•æ‰¾åˆ°`Rancher Server URL`,æœ€ç»ˆå¯¼è‡´æ— æ³•é€šä¿¡ã€‚

è§£å†³åŠæ³•ï¼šå¯ä»¥é€šè¿‡ç»™`cattle-cluster-agent Pod`å’Œ`cattle-node-agent pod`æ·»åŠ ä¸»æœºåˆ«å(/etc/hosts)ï¼Œè®©å…¶å¯ä»¥æ­£å¸¸é€šè¿‡`Rancher Server URL`ä¸Rancher Serveré€šä¿¡`(å‰ææ˜¯IPåœ°å€å¯ä»¥äº’é€š)`ã€‚

å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š

```

kubectl -n cattle-system patch  deployments cattle-cluster-agent --patch '{
    "spec": {
        "template": {
            "spec": {
                "hostAliases": [
                    {
                        "hostnames":
                        [
                            "rancher.sfkj.sit"
                        ],
                            "ip": "172.24.19.168"
                    }
                ]
            }
        }
    }
}'

kubectl -n cattle-system patch  daemonsets cattle-node-agent --patch '{
    "spec": {
        "template": {
            "spec": {
                "hostAliases": [
                    {
                        "hostnames":
                        [
                            "rancher.sfkj.sit"
                        ],
                            "ip": "172.24.19.168"
                    }
                ]
            }
        }
    }
}'
```

#### åœ¨/etc/hosts å¢åŠ è§£æ

![rancher1](../.gitbook/assets/rancher1.png)

![rancher2](../.gitbook/assets/rancher2.png)

#### å‚è€ƒ

[**Helm å®‰è£…rancher**](https://docs.rancher.cn/rancher2x/installation/helm-ha-install/online/tcp-l4/rancher-install.html)&#x20;

