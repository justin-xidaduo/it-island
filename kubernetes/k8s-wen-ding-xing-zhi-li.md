# 🥥 k8s 稳定性治理

1、**集群资源管理与调度**

**资源请求和限制**：为Pod设置适当的资源请求（request）和限制（limit），避免资源竞争和OOM（内存溢出）。使用 `VerticalPodAutoscaler` 和 `HorizontalPodAutoscaler` 来动态调整资源。

**Node Affinity 和 Pod Affinity**：合理规划Pod调度策略，确保Pod部署在合适的节点上，以便提高资源利用率和应用稳定性。

**Cluster Autoscaler**：自动调整集群节点的数量，以满足负载变化，避免资源不足导致的服务中断。

#### **2、高可用性架构设计**

* **多副本和冗余设计**：部署多个副本以提高应用的高可用性和故障容忍能力。可以通过 `ReplicaSet` 和 `Deployment` 来控制Pod副本数。
* **Pod Anti-Affinity**：避免将相关Pod调度到同一节点上，减少单点故障的风险。
* **Etcd 高可用性**：Etcd是K8s的分布式存储系统，确保它的高可用性是K8s集群稳定性的基础。可通过设置多个Etcd节点和使用合适的集群配置来提高可用性。

#### 3. **容错与自愈能力**

* **Pod重启和自愈机制**：通过设置Pod的`livenessProbe` 和 `readinessProbe` 来检测Pod的健康状态，在出现故障时自动重启Pod。
* **StatefulSet 管理有状态应用**：通过 `StatefulSet` 管理有状态应用，确保数据一致性和持久化的稳定性。
* **故障恢复**：在多区域或多可用区环境中部署K8s集群，提升容灾能力。

4、**日志与监控**

* **集群监控**：部署 Prometheus 和 Grafana 等监控工具，实时监控集群的资源使用情况、Pod状态、容器日志等，及时发现异常并响应。
* **集中式日志管理**：使用ELK（Elasticsearch, Logstash, Kibana）或其他日志收集工具集中管理日志，便于故障排查。
* **报警系统**：配置合理的报警规则（如Pod重启频繁、CPU/Memory使用过高等），避免潜在问题扩大。

5、**安全性与权限管理**

* **RBAC（Role-Based Access Control）**：确保权限管理的细粒度控制，限制用户和服务账户对资源的访问权限。
* **网络隔离与加密**：确保集群内部和外部的通信进行加密，避免数据泄露或被篡改。
* **Pod 安全策略 (PSP)**：使用Pod安全策略来限制容器运行时的权限，例如禁止运行特权容器、限制容器使用宿主机网络等。

#### 6、. **版本控制与升级策略**

* **K8s版本管理**：合理规划K8s集群的版本升级策略，避免因升级不当引发的不兼容问题。可以通过分阶段滚动升级和版本兼容性验证来降低风险。
* **依赖管理**：确保集群中使用的应用镜像版本和组件版本与K8s版本兼容，避免因组件不兼容导致的问题。

7、**灾难恢复与备份**

* **Etcd备份**：定期备份Etcd数据，确保在集群出现严重故障时能够恢复关键数据。
* **容器镜像备份**：确保应用的容器镜像可以从可靠的镜像仓库恢复，避免因镜像丢失导致服务不可用。
* **跨区域灾备**：考虑将集群部署在多个数据中心或云区域，确保在单一故障区域出现问题时能够快速切换。

8、混沌工程

在Kubernetes (K8s) 环境中，**混沌工程**（Chaos Engineering）是通过故意制造系统故障来验证系统的韧性、可靠性和恢复能力。其核心目的是通过模拟各种潜在的故障场景，发现系统在面对异常情况时的薄弱环节，从而增强系统的稳定性。

在K8s环境中，混沌工程可以从以下几个方面入手：

#### 1. **节点故障模拟**

* **杀死节点**：通过工具（如 `kubectl` 或混沌工程工具 Chaos Mesh、Gremlin 等）随机或定期杀死集群中的节点。检查Pod是否能在节点宕机时成功调度到其他节点。
* **节点资源耗尽**：故意消耗节点的CPU或内存资源，观察Pod的调度和容器的重启情况，确保集群能够在资源压力下平稳运行。

#### 2. **Pod/容器故障模拟**

* **杀死Pod或容器**：模拟Pod或容器的崩溃，观察K8s的自愈能力，检查Pod是否会自动重启或重新调度。
* **模拟Pod中的应用崩溃**：故意让容器中的应用崩溃（例如，通过发送SIGKILL信号），测试应用的恢复能力以及K8s的调度机制。
* **Pod延迟启动或不可达**：故意引入网络延迟，检查Pod的启动时间，或者模拟Pod不可达的场景，验证是否会触发自动重调度。

#### 3. **网络故障模拟**

* **网络延迟**：通过引入网络延迟（例如使用 `tc` 命令或混沌工程工具），模拟容器之间的通信延迟，检查应用在高延迟环境下的表现。
* **网络分区**：模拟网络分区（网络隔离），将部分Pod与外界或其他Pod断开连接，验证集群的高可用性和服务发现能力。
* **网络丢包**：模拟网络丢包，观察应用和K8s的处理能力，确保服务在丢包情况下的健壮性。

#### 4. **存储故障模拟**

* **存储挂载失败**：模拟存储卷挂载失败或不可用，验证K8s在处理存储故障时的反应，如Pod重启或重新调度。
* **数据丢失或延迟**：模拟持久存储的故障（如延迟写入、读写错误等），确保应用能够处理存储相关的异常。







